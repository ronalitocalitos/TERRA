import streamlit as st
import pandas as pd
import joblib
import firebase_admin
from firebase_admin import credentials, firestore

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Frontend Configuration) ---
st.set_page_config(
    page_title="TERRA - AI Fertilizer System",
    page_icon="üå±",
    layout="wide"
)

# --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (Backend - Cloud Connection) ---
@st.cache_resource
def init_firebase():
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ã‡πâ‡∏≥
    if not firebase_admin._apps:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏à‡∏≤‡∏Å Streamlit Secrets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
        key_dict = st.secrets["firebase_key"]
        cred = credentials.Certificate(dict(key_dict))
        firebase_admin.initialize_app(cred)
    return firestore.client()

# --- 3. ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI (AI Brain Loading) ---
@st.cache_resource
def load_terra_model():
    # ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏°‡∏≠‡∏á AI ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡∏ö‡∏ô GitHub
    return joblib.load("terra_model.pkl")

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
db = init_firebase()
model_data = load_terra_model()
clf = model_data['classifier']
reg = model_data['regressor']

# --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î‡∏à‡∏≤‡∏Å Cloud ---
def get_sensor_latest():
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Collection 'sensor_data' ‡πÅ‡∏•‡∏∞ Document 'latest'
    doc_ref = db.collection('sensor_data').document('latest')
    doc = doc_ref.get()
    if doc.exists:
        return doc.to_dict()
    return None

# --- 5. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (UI Design) ---
st.title("üå± TERRA: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏∏‡πã‡∏¢‡∏•‡∏≥‡πÑ‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞")
st.markdown("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÇ‡∏î‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏° Computer Engineering CMU")

# ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
sensor_data = get_sensor_latest()

if sensor_data:
    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Sensor ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á Metric ‡∏™‡∏ß‡∏¢‡πÜ
    st.subheader("üì° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏™‡∏ß‡∏ô (Real-time Cloud Data)")
    m1, m2, m3, m4, m5 = st.columns(5)
    m1.metric("Nitrogen (N)", f"{sensor_data.get('N', 0)} g")
    m2.metric("Phosphorus (P)", f"{sensor_data.get('P', 0)} g")
    m3.metric("Potassium (K)", f"{sensor_data.get('K', 0)} g")
    m4.metric("‡∏Ñ‡πà‡∏≤ pH (‡∏î‡∏¥‡∏ô)", sensor_data.get('pH', 0))
    m5.metric("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Moisture)", f"{sensor_data.get('Moist', 0)}%")
    
    st.divider()

    # ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å User
    st.subheader("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (User Input)")
    col_input1, col_input2 = st.columns(2)
    
    with col_input1:
        stage_name = st.selectbox(
            "‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏•‡∏≥‡πÑ‡∏¢:",
            ["‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡πâ‡∏ô", "‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•", "‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß"]
        )
    with col_input2:
        yield_target = st.number_input("‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏Å‡∏Å./‡∏ï‡πâ‡∏ô):", min_value=1, value=100)

    # ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô AI
    if st.button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢", use_container_width=True):
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà AI ‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        stage_map = {"‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡πâ‡∏ô": 1, "‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£": 2, "‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ú‡∏•": 3, "‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß": 4}
        
        # ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ AI (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á Column ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡πÉ‡∏ô Colab)
        input_df = pd.DataFrame([[
            sensor_data.get('N', 0), sensor_data.get('P', 0), sensor_data.get('K', 0),
            sensor_data.get('pH', 0), sensor_data.get('Moist', 0), 
            stage_map[stage_name], yield_target
        ]], columns=['N_soil', 'P_soil', 'K_soil', 'pH', 'Moisture', 'Stage', 'Target_Yield_kg'])

        # ‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≤‡∏¢‡∏ú‡∏•
        action_result = clf.predict(input_df)[0]
        nums_result = reg.predict(input_df)[0] # [Lime, N, P, K]

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        st.success(f"### üí° ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI: \n {action_result}")
        
        st.markdown("#### üß™ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:")
        res_col1, res_col2, res_col3, res_col4 = st.columns(4)
        res_col1.info(f"**‡πÑ‡∏ô‡πÇ‡∏ï‡∏£‡πÄ‡∏à‡∏ô (N)**\n{nums_result[1]:.1f} ‡∏Å‡∏£‡∏±‡∏°")
        res_col2.info(f"**‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™ (P)**\n{nums_result[2]:.1f} ‡∏Å‡∏£‡∏±‡∏°")
        res_col3.info(f"**‡πÇ‡∏û‡πÅ‡∏ó‡∏™‡πÄ‡∏ã‡∏µ‡∏¢‡∏° (K)**\n{nums_result[3]:.1f} ‡∏Å‡∏£‡∏±‡∏°")
        res_col4.warning(f"**‡∏õ‡∏π‡∏ô‡∏Ç‡∏≤‡∏ß (Lime)**\n{nums_result[0]:.2f} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°")

else:
    st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Cloud (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Arduino/ESP32)")
    if st.button("üîÑ ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"):
        st.rerun()

# ‡∏ü‡∏∏‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå
st.divider()
st.caption("Project Terra | Computer Engineering, Chiang Mai University 2026")